#!/bin/bash

# installs devskim in $1

set -e
MYDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

INSTALL_DIR=$1

if [[ -z "$INSTALL_DIR" ]]; then
    echo "Missing an argument.
Usage: $0 directory-to-install-devskim-in" >&2
   exit 1
fi

function abspath() { pushd . > /dev/null; if [ -d "$1" ]; then cd "$1"; dirs -l +0; else cd "`dirname \"$1\"`"; cur_dir=`dirs -l +0`; if [ "$cur_dir" == "/" ]; then echo "$cur_dir`basename \"$1\"`"; else echo "$cur_dir/`basename \"$1\"`"; fi; fi; popd > /dev/null; }
INSTALL_DIR=$(abspath "$INSTALL_DIR")

mkdir -p "${INSTALL_DIR}"

TMP=$(mktemp -d devskim-download-XXXXXX)

cd $TMP
REPO=microsoft/DevSkim
NAME=DevSkim_CLI_linux_1.0.23
curl -LO "https://github.com/${REPO}/releases/download/v1.0.23/${NAME}.zip"
unzip "${NAME}.zip" > /dev/null
mv "${NAME}"/* "${INSTALL_DIR}/"

BIN="${INSTALL_DIR}/devskim"
chmod +x "${BIN}"

if [ ! -f "${BIN}" ]; then
    echo "ERROR: The download and extraction of devskim completed successfully, but ${BIN} does not exist?!">&2
    exit 1
fi
if [ ! -x "${BIN}" ]; then
    echo "ERROR: The download and extraction of devskim completed successfully, but ${BIN} is not executable?! ">&2
    exit 1
fi

MAIN="${MYDIR}/../../../../build/ts/contrib/tools/devskim/src/devskim.js"
MAIN=$(abspath "$MAIN")
echo "The devskim tool has been installed. Add the fragment below to a config.json file:

{
    ...
    \"tools\": {
        ...

        \"devskim-default\": {
            \"bin\": \"node\",
            \"args\": [
                \"${MAIN}\"
            ],
            \"options\": {
              \"devskimDir\": \"${INSTALL_DIR}\"
            }

        }

        ...
    }
    ...
}

"
