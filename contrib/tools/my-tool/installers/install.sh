#!/bin/bash

# install ossf-sast-ml in $1

set -e
MYDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

INSTALL_DIR=$1

if [[ -z "$INSTALL_DIR" ]]; then
    echo "Missing an argument.
Usage: $0 directory-to-install-ossf-sast-ml-in" >&2
   exit 1
fi

function abspath() { pushd . > /dev/null; if [ -d "$1" ]; then cd "$1"; dirs -l +0; else cd "`dirname \"$1\"`"; cur_dir=`dirs -l +0`; if [ "$cur_dir" == "/" ]; then echo "$cur_dir`basename \"$1\"`"; else echo "$cur_dir/`basename \"$1\"`"; fi; fi; popd > /dev/null; }
INSTALL_DIR=$(abspath "$INSTALL_DIR")

mkdir -p "${INSTALL_DIR}"

TMP=$(mktemp -d ossf-sast-ml-download-XXXXXX)

# download latest release of ossf-sast-ml
cd $TMP
curl -LO "https://github.com/viszkoktamas/ossf-sast-ml/archive/refs/heads/main.zip"
unzip "main.zip" > /dev/null
mv ossf-sast-ml-main/* "${INSTALL_DIR}/"
cd "${INSTALL_DIR}"
# install node dependencies
npm i -y > /dev/null
# install python dependencies
pip install -r inference/requirements.txt
# fix line endings
sed -i 's/\r$//' ./inference.sh
# make inference.sh executable
chmod +x ./inference.sh

BIN="${INSTALL_DIR}/my-tool.js"

if [ ! -f "${BIN}" ]; then
    echo "ERROR: The download and extraction of ossf-sast-ml completed successfully, but ${BIN} does not exist?!">&2
    exit 1
fi

MAIN="${MYDIR}/../../../../build/ts/contrib/tools/my-tool/src/my-tool.js"
MAIN=$(abspath "$MAIN")
echo "The ossf-sast-ml tool has been installed. Add the fragment below to a config.json file:

{
    ...
    \"tools\": {
        ...

        \"my-tool\": {
            \"bin\": \"node\",
            \"args\": [
                \"${MAIN}\"
            ],
            \"options\": {
              \"my-toolDir\": \"${INSTALL_DIR}\"
            }

        }

        ...
    }
    ...
}

"
