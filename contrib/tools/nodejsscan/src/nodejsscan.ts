import * as path from "path";
import {
  AnalyzeParams,
  drive,
  execFileSyncWithImprovedExceptionMessage,
  getDriverCommandlineInputs,
  simpleSpawn
} from "../../../../src/driver";
import { BCVEResultStatus, Dir, File } from "../../../../src/persistent-types";
import { convertSarifLogToAlerts, readJSONFile } from "../../../../src/util";

/**
 * @param njsscanDir The directory `<dir>` of `pip3 install -t <dir> njsscan ...`.
 * @param timeout The number of milliseconds the analysis can run before it's forced to stop.
 */
function analyzeWithDriver(njsscanDir: Dir, timeout: number): Promise<void> {
  async function analyze({
    commitDescription,
    tmp,
    setReproduction,
    setAlerts,
    setStatus
  }: AnalyzeParams) {
    // STEP 1: preparations for the run
    let njsscanBinDir = path.join(njsscanDir, "bin"),
      njsscan = path.join(njsscanBinDir, "njsscan"),
      env = {
        ...process.env,
        PYTHONPATH: [njsscanDir, process.env.PYTHONPATH].join(path.delimiter),
        PATH: [njsscanBinDir, process.env.PATH].join(path.delimiter)
      };

    // check if `njsscan` works as expected
    execFileSyncWithImprovedExceptionMessage(njsscan, ["--help"], { env });

    let sarifFile: File = path.join(tmp, "results.sarif"),
      args: string[] = [
        "--sarif",
        "--output",
        sarifFile,
        "--missing-control",
        commitDescription.localSourceDirectory
      ];

    let reproduction = [
      `echo "Please set $PYTHONPATH and $PATH appropriately first"`,
      `cd ${tmp}`,
      `${njsscan} ${args.join(" ")}`
    ].join(" &&\n ");
    setReproduction(reproduction);

    // STEP 2: run njsscan
    await simpleSpawn(njsscan, args, tmp, timeout, setStatus, env);

    // STEP 3: process the njsscan outputs
    let alerts = convertSarifLogToAlerts(readJSONFile(sarifFile));
    // change the absolute URL paths in the sarif output to relative
    alerts.forEach(
      a =>
        (a.location.file = path.relative(
          commitDescription.localSourceDirectory,
          new URL(a.location.file).pathname
        ))
    );
    setAlerts(alerts);
    setStatus(BCVEResultStatus.SUCCESS);
  }
  return drive(analyze);
}

let { toolID, config } = getDriverCommandlineInputs();
analyzeWithDriver(
  config.tools[toolID].options.nodejsscanDir,
  config.tools[toolID].timeout
)
  .then(() => process.exit(0))
  .catch(e => {
    console.error(e);
    process.exit(1);
  });
